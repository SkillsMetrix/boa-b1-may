---
- name: Remove port 80 from Apache2 (Ubuntu)
  hosts: webservers
  become: yes
  vars:
    apache_port_to_keep: 8081  # Define the port you want to keep

  tasks:
    - name: Ensure only custom port is in ports.conf
      ansible.builtin.lineinfile:
        path: /etc/apache2/ports.conf
        regexp: '^Listen '
        line: "Listen {{ apache_port_to_keep }}"
        backup: yes
        state: present
        create: yes

    - name: Remove VirtualHost on port 80 from 000-default.conf
      ansible.builtin.replace:
        path: /etc/apache2/sites-available/000-default.conf
        regexp: '(<VirtualHost\s+\*:)(80)'
        replace: '\1{{ apache_port_to_keep }}'

    - name: Restart Apache2
      ansible.builtin.service:
        name: apache2
        state: restarted
        enabled: yes
